language: node_js

node_js:
  - node

dist: trusty

cache:
  npm: true
  directories:
    - '$HOME/.sonar/cache'
    - '~/.cache'

# Build only commits on master and release tags preventing double builds for PRs
# See https://docs.travis-ci.com/user/pull-requests/#double-builds-on-pull-requests
branches:
  only:
    - master
    - /v[0-9]+\.[0-9]+\.[0-9]+(-.*)?$/

addons:
  sonarcloud:
    organization: "ontotext-ad"
    token:
      secure: $SONAR_TOKEN
  # Needed for Cypress tests
  apt:
    packages:
      - libgconf-2-4

script:
  - npm run test:coverage
  - npm run build
  - npm run sonar

after_script:
  - npm run test:coveralls
  - echo "test"
  - npm run test:acceptance

deploy:
  - provider: npm
    skip_cleanup: true
    email: graphdb-support@ontotext.com
    api_key: $NPM_TOKEN
    on:
      tags: true
  - provider: script
    skip_cleanup: true
    script: cd test-cypress/ && npm publish
    on:
      tags: true
